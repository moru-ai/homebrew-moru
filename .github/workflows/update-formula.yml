name: Update Formula

on:
  repository_dispatch:
    types: [cli-release]
  workflow_dispatch:
    inputs:
      version:
        description: '버전 (예: 0.3.3)'
        required: true
        type: string
      tag:
        description: 'GitHub 릴리스 태그 (예: @moru-ai/cli@0.3.3)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  update-formula:
    name: Update Moru Formula
    runs-on: macos-latest
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Set version from input or event
        id: version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
            TAG="${{ github.event.client_payload.tag }}"
          else
            VERSION="${{ inputs.version }}"
            TAG="${{ inputs.tag }}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"
          echo "Tag: $TAG"

      - name: Download SHA256SUMS
        id: checksums
        run: |
          TAG_ENCODED=$(echo "${{ steps.version.outputs.tag }}" | jq -sRr @uri)
          SUMS_URL="https://github.com/moru-ai/sdks/releases/download/${TAG_ENCODED}/SHA256SUMS"

          echo "Downloading from: $SUMS_URL"
          curl -fsSL "$SUMS_URL" -o SHA256SUMS

          SHA_ARM64=$(grep "darwin-arm64" SHA256SUMS | awk '{print $1}')
          SHA_X64=$(grep "darwin-x64" SHA256SUMS | awk '{print $1}')

          echo "sha_arm64=$SHA_ARM64" >> "$GITHUB_OUTPUT"
          echo "sha_x64=$SHA_X64" >> "$GITHUB_OUTPUT"

          echo "ARM64 SHA: $SHA_ARM64"
          echo "x64 SHA: $SHA_X64"

      - name: Update formula
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ steps.version.outputs.tag }}
          SHA_ARM64: ${{ steps.checksums.outputs.sha_arm64 }}
          SHA_X64: ${{ steps.checksums.outputs.sha_x64 }}
        run: |
          TAG_ENCODED=$(echo "$TAG" | jq -sRr @uri)

          cat > Formula/moru.rb << 'EOF'
          class Moru < Formula
            desc "CLI for managing Moru sandbox templates"
            homepage "https://github.com/moru-ai/sdks"
            license "Apache-2.0"

            on_macos do
              on_arm do
                url "https://github.com/moru-ai/sdks/releases/download/TAG_ENCODED_PLACEHOLDER/moru-vVERSION_PLACEHOLDER-darwin-arm64"
                sha256 "SHA_ARM64_PLACEHOLDER"

                def install
                  bin.install "moru-vVERSION_PLACEHOLDER-darwin-arm64" => "moru"
                end
              end

              on_intel do
                url "https://github.com/moru-ai/sdks/releases/download/TAG_ENCODED_PLACEHOLDER/moru-vVERSION_PLACEHOLDER-darwin-x64"
                sha256 "SHA_X64_PLACEHOLDER"

                def install
                  bin.install "moru-vVERSION_PLACEHOLDER-darwin-x64" => "moru"
                end
              end
            end

            test do
              system "#{bin}/moru", "--version"
            end
          end
          EOF

          # 플레이스홀더 치환
          sed -i '' "s|TAG_ENCODED_PLACEHOLDER|${TAG_ENCODED}|g" Formula/moru.rb
          sed -i '' "s|VERSION_PLACEHOLDER|${VERSION}|g" Formula/moru.rb
          sed -i '' "s|SHA_ARM64_PLACEHOLDER|${SHA_ARM64}|g" Formula/moru.rb
          sed -i '' "s|SHA_X64_PLACEHOLDER|${SHA_X64}|g" Formula/moru.rb

          cat Formula/moru.rb

      - name: Test formula
        run: |
          brew audit --strict --online Formula/moru.rb
          brew install --build-from-source Formula/moru.rb
          moru --version

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/moru.rb
          git commit -m "Update moru formula to v${{ steps.version.outputs.version }}"
          git push

      - name: Create PR (fallback if direct push fails)
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="update-formula-${{ steps.version.outputs.version }}"
          git checkout -b "$BRANCH"
          git push origin "$BRANCH"
          gh pr create \
            --title "Update moru formula to v${{ steps.version.outputs.version }}" \
            --body "Automated formula update for Moru CLI v${{ steps.version.outputs.version }}" \
            --base main \
            --head "$BRANCH"
